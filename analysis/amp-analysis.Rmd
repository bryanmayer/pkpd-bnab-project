---
title: "amp-analysis"
author: "Bryan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

## AMP analysis

This is a very simplistic AMP analysis, where we use the IC80 vs. PE curve and the population concentration data to derive a titer vs. PE relationship.

```{r, message = F, warning = F}

library(tidyverse)
library(kableExtra)
library(cowplot)
library(viridis)
library(VISCPK)
library(readxl)

theme_set(theme_bw() + theme(legend.position = "top", legend.key.width = unit(1, "cm"),
                             legend.box = "vertical"))

ic80_pe = read_excel("../data/nejm_fig3a.xlsx", col_names = c("ic80", "pe"))

```


## IC80 vs. PE

Tells us vaguely about protection relative to virus sensitivity. But this is implicitly time-dependent because IC80 relates to actual protection through VRC01 concentration. This dose-response relationship is actually strictly conditioned on a population receiving the AMP regimens.

We could interpret this plot in the following way: if we select a random AMP participant, this is their predicted PE across the distribution of circulating viruses (ie, given an exposing virus IC80). A more sophisticated analysis would derive the ID80 at time of exposure for each participant and draw the dose-response between ID80 and PE. The ID80 dose-response relationship can theoretically be extended to any dosing regimen of VRC01. The titer relationship may even extend to other bNAbs.

```{r}

ic80_pe %>%
  ggplot(aes(x = ic80, y = pe)) +
  geom_point() +
  geom_line() +
  scale_x_log10()


```

## AMP concentrations

```{r conc-data}

amp_conc_data = tribble(
  ~dose_mgkg, ~study, ~n, ~peak, ~midpoint, ~trough,
  10, 704, 895, 65.7, 23.1, 5.8,
  30, 704, 894, 212, 55.1, 15.4,
  10, 703, 642, 88.9, 19.8, 4.7,
  30, 703, 645, 257.9, 44.7, 8.3
)

amp_conc_data %>%
  kable(caption = "NEJM Table1: VRC01 concentration data. Peak = day 61.") %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 3, "Conc. (ug/ml)" = 3))

```

Suppose you selected an AMP participant at random, you could predict their average concentrations at the each time endpoint using a weighted mean. This can be overall (any 703 or 704 participant), by dose, or by study.

```{r mean-conc}
amp_conc_avg = amp_conc_data %>%
  mutate(weight = n / sum(n)) %>%
  summarize(across(c(peak, midpoint, trough), ~sum(. * weight)), .groups = "drop")

amp_conc_dose = amp_conc_data %>%
  group_by(dose_mgkg) %>%
  mutate(weight = n / sum(n)) %>%
  summarize(across(c(peak, midpoint, trough), ~sum(. * weight)), .groups = "drop")

amp_conc_grp = amp_conc_data %>%
  group_by(study) %>%
  mutate(weight = n / sum(n)) %>%
  summarize(across(c(peak, midpoint, trough), ~sum(. * weight)), .groups = "drop")

amp_conc_avg %>%
  kable(caption = "Weighted mean VRC01 concentration by dose. Peak = day 61.", digits = 1) %>%
  kable_styling(full_width = F) %>%
  add_header_above(c("Wgt. mean conc. (ug/ml)" = 3))

amp_conc_dose %>%
  kable(caption = "Mean VRC01 concentration by dose. Peak = day 61.", digits = 1) %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 1, "Wgt. mean conc. (ug/ml)" = 3))

amp_conc_grp %>%
  kable(caption = "Mean VRC01 concentration by study. Peak = day 61.", digits = 1) %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 1, "Wgt. mean conc. (ug/ml)" = 3))

```

## Titer

If we select a random participant and a random virus IC80, we can translate the IC80 dose-response curve by scaling (dividing) the x-axis IC80 by the average concentration value of interest. *Suppose* we knew everyone was infected at their midpoint, then we could scale by the average midpoint concentration. Without knowledge of infection time, there are many ways to randomly select a concentration. For simplicity, we just look at each trough, midpoint, and peak.

```{r}
neutralization = tibble(
  id80 = 10^seq(-0.1, log10(2000), length = 100),
  id50 = 4 * id80,
  time = "neutralization", 
  pe = 100 * 1/(1+1/(id50))
  )

titer_pe = ic80_pe %>%
  crossing(time = c("peak", "midpoint", "trough")) %>%
  left_join(gather(amp_conc_avg, time, mean_conc, midpoint, peak, trough), by = "time") %>%
  mutate(
    id80 = mean_conc/ic80,
    id50 = 4 * id80
  ) 

ggplot(titer_pe, aes(x = id80, y = pe, colour = time)) +
  geom_point() +
  geom_line() +
  geom_line(data = neutralization) +
  scale_x_log10() +
  scale_color_discrete("", breaks = c("neutralization", "trough", "midpoint", "peak"))

```

With a Hill slope of 1 (linking IC50 and IC80), the ID50 titer is 4 times higher than ID80 titer at a given concentration.

```{r}

ggplot(titer_pe, aes(x = id50, y = pe, colour = time)) +
  geom_point() +
  geom_line() +
  geom_line(data = neutralization) +
  scale_x_log10() +
  scale_color_discrete("", breaks = c("neutralization", "trough", "midpoint", "peak"))

```

## Dose-response compared to Pegu

### Pegu data and model

```{r pegu-curve, warning=F}

pegu_dat = tibble(
  id50 = c(91, 219, 685),
  neut = c(0.5, 0.75, 0.95)
)
empirical_pd_fit = drc::drm(neut ~ id50, data = pegu_dat, 
                        fct = drc::LL.5(names = c("slope", "lower", "upper",
                                                  "inflection", "asymmetry"),
                             fixed = c(NA, 0, 1, NA, NA)))


empirical_4pl_fit = drc::drm(neut ~ id50, data = pegu_dat, 
                        fct = drc::LL.4(names = c("slope", "lower", "upper",
                                                  "inflection"),
                             fixed = c(NA, 0, 1, NA)))

pegu_mod = tibble(
  id50 = 10^seq(-0.1, 4.5, length = 100),
  #invitro = 1 - (1 + titer)^(-1),
  mod5pl = predict(empirical_pd_fit, data.frame(id50 = id50)),
  mod4pl = predict(empirical_4pl_fit, data.frame(id50 = id50)),
  potency =  1 - (1 + id50/91)^(-1)
) 

pegu_mod %>%
  gather(model, neut, mod4pl, mod5pl, potency) %>%
  ggplot(aes(x = id50, y = neut * 100)) +
  geom_line(aes(colour = model, linetype = model)) +
  geom_point(data = pegu_dat) +
  scale_y_continuous(breaks = 0:10 * 10) +
  labs(y = "Pegu et al. empirical protection (%)", x = "id50",
       colour = "", linetype = "") +
  scale_color_manual(breaks = c("mod4pl", "mod5pl", "potency"), 
                     labels = c("4PL", "5PL", 
                                "Potency reduction"),
                     values = c("black", "black", "gray")) +
  scale_linetype_manual(breaks = c("mod4pl", "mod5pl", "potency"), 
                     labels = c("4PL", "5PL", 
                                "Potency reduction"),
                     values = c(2, 1, 1)) +
  scale_x_log10(breaks = 10^(0:4), labels = as.character(10^(0:4))) +
  theme(axis.text.x = element_text(size = 8), 
        legend.key.width = unit(0.5, "cm"), 
        legend.key.height =  unit(0.5, "cm"),
        legend.margin = margin(t = -10,0,0,0),
        legend.box.background = element_rect(colour = "black"),
        legend.position = c(1, 0), legend.text = element_text(size = 7),
        legend.direction = "vertical", 
        legend.justification = c(1.01, -.10))

```

### Pegu vs. AMP ID50 data

```{r}

ggplot(mutate(titer_pe, time2 = "AMP"), aes(x = id50, y = pe, colour = time2)) +
  geom_point() +
  geom_line(aes(linetype = time)) +
  geom_line(data = mutate(neutralization, time2 = "Neut.")) +
  geom_line(data = mutate(pegu_mod, time2 = "Pegu 5PL"), aes(y = 100*mod4pl)) +
  scale_x_log10() +
  coord_cartesian(xlim = c(10, NA)) +
  scale_color_manual("", breaks = c("Neut.", "Pegu 5PL", "AMP"), 
                     values = c("blue", "red", "black")) +
  scale_linetype_manual("AMP Conc. input", breaks = c("trough", "midpoint", "peak"),
                     values = c(3, 1, 2)) 

```

### Pegu vs. AMP ID50 5PL models

```{r amp-5pl}


amp_pd_fit = titer_pe %>%
  group_by(time) %>%
  nest() %>%
  mutate(mod = map(data, ~drc::drm(pe ~ id50, data = ., 
                        fct = drc::LL.5(names = c("slope", "lower", "upper",
                                                  "inflection", "asymmetry"),
                             fixed = c(NA, 0, 100, NA, NA)))),
         pred = map(mod, ~tibble(id50 = 10^seq(-0.1, 4.5, length = 100),
                                pe = predict(., data.frame(id50 = id50))))
  )
amp_pd_fit %>%
  unnest(cols = pred) %>%
  mutate(time2 = "AMP 5PL") %>%
  ggplot(aes(x = id50, y = pe, colour = time2)) +
  geom_point(data = titer_pe, colour = "black") +
  geom_line(aes(linetype = time)) +
  geom_line(data = mutate(neutralization, time2 = "Neut.")) +
  geom_line(data = mutate(pegu_mod, time2 = "Pegu 5PL"), aes(y = 100*mod4pl)) +
  scale_x_log10() +
  coord_cartesian(xlim = c(10, NA)) +
  scale_color_manual("", breaks = c("Neut.", "Pegu 5PL", "AMP 5PL"), 
                     values = c("blue", "red", "black")) +
  scale_linetype_manual("AMP Conc. input", breaks = c("trough", "midpoint", "peak"),
                     values = c(3, 1, 2)) 

```
